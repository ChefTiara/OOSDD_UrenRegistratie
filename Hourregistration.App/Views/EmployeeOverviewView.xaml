<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Hourregistration.App.ViewModels"
             xmlns:m="clr-namespace:Hourregistration.Core.Models;assembly=Hourregistration.Core"
             x:Class="Hourregistration.App.Views.EmployeeOverviewView"
             x:DataType="vm:EmployeeOverviewViewModel"
             Title="{Binding PageTitle}">

    <!-- Grid with an extra Auto row for the sort button -->
    <Grid Padding="12" RowDefinitions="Auto,Auto,Auto,*,Auto" ColumnDefinitions="*" RowSpacing="8">
        <!-- Button bar replaced with a 3-column Grid:
             Column 0: left buttons (Auto)
             Column 1: flexible spacer (*)
             Column 2: week selector (Auto, pinned to right) -->
        <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8" VerticalOptions="Center">
            <!-- Left-side buttons -->
            <HorizontalStackLayout Grid.Column="0" Spacing="8" HorizontalOptions="Start" VerticalOptions="Center">
                <!-- Filters: Projectnaam, Status, Datum (date filter uses DatePicker)  -->
                <StackLayout Orientation="Horizontal" Spacing="6" VerticalOptions="Center">
                    <Picker ItemsSource="{Binding ProjectOptions}"
                            SelectedItem="{Binding SelectedProjectOption}"
                            Title="Projectnaam"
                            WidthRequest="160"
                            HeightRequest="70"
                            VerticalOptions="Center"/>
                    <Picker ItemsSource="{Binding StateOptions}"
                            SelectedItem="{Binding SelectedStateOption}"
                            Title="Status"
                            WidthRequest="120"
                            HeightRequest="70"
                            VerticalOptions="Center"/>

                    <!-- DatePicker with a label above to match other controls -->
                    <StackLayout Orientation="Vertical" Spacing="2" VerticalOptions="Center">
                        <Label Text="Datum" FontSize="14" Opacity="0.8" VerticalOptions="Center" HorizontalOptions="Start" />
                        <DatePicker
                            Date="{Binding SelectedDateNonNull, Mode=TwoWay}"
                            Format="dd-MM-yyyy"
                            WidthRequest="140"
                            VerticalOptions="Center" />
                    </StackLayout>
                </StackLayout>

                <!-- additional left-side buttons can go here -->
            </HorizontalStackLayout>

            <!-- Middle column is flexible and will expand to push the week selector to the right -->
            <BoxView Grid.Column="1" BackgroundColor="Transparent" HorizontalOptions="Fill" />

            <!-- Week selector pinned to the right -->
            <HorizontalStackLayout Grid.Column="2" Spacing="6" VerticalOptions="Center" HorizontalOptions="End">
                <!-- Refresh icon-only button placed on the left of the week selector -->
                <Button Command="{Binding RefreshCommand}"
                        AutomationId="RefreshButton"
                        Padding="6"
                        WidthRequest="40"
                        HeightRequest="40"
                        HorizontalOptions="End">
                    <Button.ImageSource>
                        <FontImageSource Glyph="&#xE117;" FontFamily="Segoe MDL2 Assets" Size="18" Color="Black" />
                    </Button.ImageSource>
                </Button>
                
                <Button Command="{Binding PreviousWeekCommand}" Padding="6" AutomationId="PrevWeekButton">
                    <Button.ImageSource>
                        <FontImageSource Glyph="&#xE72B;" FontFamily="Segoe MDL2 Assets" Size="18" Color="Black" />
                    </Button.ImageSource>
                </Button>

                <Frame Padding="6,3" HasShadow="False" BorderColor="Transparent" BackgroundColor="Transparent" VerticalOptions="Center">
                    <Label Text="{Binding WeekLabel}" VerticalOptions="Center" HorizontalOptions="Center" />
                </Frame>

                <Button Command="{Binding NextWeekCommand}" Padding="6" AutomationId="NextWeekButton">
                    <Button.ImageSource>
                        <FontImageSource Glyph="&#xE72A;" FontFamily="Segoe MDL2 Assets" Size="18" Color="Black" />
                    </Button.ImageSource>
                </Button>
            </HorizontalStackLayout>
        </Grid>

        <!-- Header row matching the item Grid columns (moved to Row 2 so it sits below buttons)
             NOTE: left margin increased so header columns align with Frame content inside items -->
        <Grid Grid.Row="2" ColumnSpacing="24" RowDefinitions="Auto" ColumnDefinitions="70,90,70,140,*,Auto" Margin="12,0">
            <Label Grid.Column="0" Text="Dag" FontAttributes="Bold" FontSize="12" VerticalOptions="Center" HorizontalOptions="Start" />
            <Label Grid.Column="1" Text="Datum" FontAttributes="Bold" FontSize="12" VerticalOptions="Center" HorizontalOptions="Start" />
            
            <!--
            <Label Grid.Column="2" Text="Ingepland" FontAttributes="Bold" FontSize="12" VerticalOptions="Center" HorizontalOptions="Start" />
            -->
            
            <Label Grid.Column="2" Text="Uren" FontAttributes="Bold" FontSize="12" VerticalOptions="Center" HorizontalOptions="Start" />
            <Label Grid.Column="3" Text="Reden" FontAttributes="Bold" FontSize="12" VerticalOptions="Center" HorizontalOptions="Start" LineBreakMode="TailTruncation" />
            <Label Grid.Column="4" Text="Beschrijving" FontAttributes="Bold" FontSize="12" VerticalOptions="Center" HorizontalOptions="Start" LineBreakMode="TailTruncation" />
            <Label Grid.Column="5" Text="Status" FontAttributes="Bold" FontSize="12" VerticalOptions="Center" HorizontalOptions="End" />
        </Grid>

        <!-- CollectionView occupies the star row so its height is stable -->
        <CollectionView
            Grid.Row="3"
            x:Name="DeclaredHoursCollection"
            ItemsSource="{Binding DeclaredHoursList}"
            SelectionMode="None"
            VerticalOptions="Fill"
            HorizontalOptions="Fill"
            ItemSizingStrategy="MeasureAllItems">

            <CollectionView.EmptyView>
                <Label Text="Geen gewerkte uren gevonden." HorizontalOptions="Center" VerticalOptions="Center" Opacity="0.7"/>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="m:DeclaredHours">
                    <!-- Constrain item height so rows are consistent and avoid clipping.
                         If you want max performance, keep a fixed HeightRequest and remove MeasureAll. -->
                    <Frame Margin="4" Padding="8,8,12,8" HasShadow="True" CornerRadius="6" MinimumHeightRequest="46">
                        <Grid ColumnSpacing="24" RowDefinitions="Auto" ColumnDefinitions="70,90,70,140,*,Auto">
                            <Label Grid.Column="0" Text="{Binding Day}" VerticalOptions="Center" FontSize="12" LineBreakMode="NoWrap" MaxLines="1" HorizontalOptions="Start" />
                            <Label Grid.Column="1" Text="{Binding Date, StringFormat='{0:dd-MM-yyyy}'}" VerticalOptions="Center" FontSize="12" LineBreakMode="NoWrap" MaxLines="1" HorizontalOptions="Start"/>
                            
                            <!--
                            <Label Grid.Column="2" Text="{Binding PlannedHours}" VerticalOptions="Center" FontSize="12" LineBreakMode="NoWrap" MaxLines="1" HorizontalOptions="Start"/>
                            -->
                            
                            <Label Grid.Column="2" Text="{Binding WorkedHours, StringFormat='{}{0}u'}" VerticalOptions="Center" FontAttributes="Bold" FontSize="14" LineBreakMode="NoWrap" MaxLines="1" HorizontalOptions="Start"/>
                            <Label Grid.Column="3" Text="{Binding Reason}" VerticalOptions="Center" FontSize="14" LineBreakMode="TailTruncation" MaxLines="1" HorizontalOptions="Start" />
                            <Label Grid.Column="4" Text="{Binding Description}" VerticalOptions="Center" FontSize="12" Opacity="0.75" LineBreakMode="TailTruncation" MaxLines="1" HorizontalOptions="Fill"/>

                            <!-- State + Segoe MDL2 icon in the last column -->
                            <HorizontalStackLayout Grid.Column="5" HorizontalOptions="End" VerticalOptions="Center" Spacing="6">
                                <Label Text="{Binding State}" VerticalOptions="Center" FontSize="12" Opacity="0.9" LineBreakMode="NoWrap" MaxLines="1" HorizontalOptions="End">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding State}" Value="Akkoord">
                                            <Setter Property="TextColor" Value="LightGreen" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding State}" Value="Geweigerd">
                                            <Setter Property="TextColor" Value="Red" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding State}" Value="Verzonden">
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>

                                <Label VerticalOptions="Center" FontSize="16" FontFamily="Segoe MDL2 Assets" HorizontalOptions="End">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding State}" Value="Akkoord">
                                            <Setter Property="Text" Value="&#xE73E;" />
                                            <Setter Property="TextColor" Value="LightGreen" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding State}" Value="Geweigerd">
                                            <Setter Property="Text" Value="&#xE711;" />
                                            <Setter Property="TextColor" Value="Red" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding State}" Value="Verzonden">
                                            <Setter Property="Text" Value="&#xE119;" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </HorizontalStackLayout>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Footer: total worked hours pinned to bottom -->
        <Label Grid.Row="4"
               Text="{Binding TotalWorkedHours}"
               FontAttributes="Bold"
               FontSize="16"
               Opacity="0.8"
               VerticalOptions="Center"
               HorizontalOptions="Start" />
    </Grid>
</ContentPage>